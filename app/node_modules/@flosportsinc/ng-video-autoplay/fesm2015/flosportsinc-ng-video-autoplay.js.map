{"version":3,"file":"flosportsinc-ng-video-autoplay.js","sources":["ng://@flosportsinc/ng-video-autoplay/lib/ng-video-autoplay.directive.ts","ng://@flosportsinc/ng-video-autoplay/lib/ng-video-autoplay.module.ts"],"sourcesContent":["import { Directive, ElementRef, Input, Renderer2, OnDestroy, AfterContentInit, ContentChildren, QueryList } from '@angular/core'\nimport { share, takeUntil, map, flatMap, filter, tap, take } from 'rxjs/operators'\nimport { fromEvent, Subject, Observable } from 'rxjs'\nimport { maybe, either } from 'typescript-monads'\n\ninterface VideoHaltStatus {\n  readonly videoElement: HTMLVideoElement\n  readonly halted: boolean\n}\n\n// tslint:disable:no-object-mutation\nconst filterHalted =\n  (source: Observable<VideoHaltStatus>) =>\n    source.pipe(filter(res => res.halted === true))\n\nconst tryPlayVideoAsIs =\n  (source: Observable<HTMLVideoElement>) =>\n    source.pipe(flatMap(videoElement => videoElement.play()\n      .then(() => ({ videoElement, halted: false }))\n      .catch(() => ({ videoElement, halted: true }))\n    ), filterHalted)\n\nconst tryPlayVideoMuted =\n  (source: Observable<VideoHaltStatus>) =>\n    source.pipe(map(res => {\n      res.videoElement.muted = true\n      res.videoElement.volume = 0\n      return res.videoElement\n    }), tryPlayVideoAsIs)\n\n// 1) attempt to play as-is (including autoplay + unmuted)\n// 2) attempt to play muted, showing unmite button\n// 3) show click to play\n@Directive({\n  selector: '[floVideoAutoplay]'\n})\nexport class FloVideoAutoplayDirective implements AfterContentInit, OnDestroy {\n  @Input() public readonly floVideoAutoplay = true\n  @Input() public readonly floVideoAutoplayClickUnmuteRef?: HTMLElement\n  @Input() public readonly floVideoAutoplayClickPlayRef?: HTMLElement\n  @Input() public readonly floVideoAutoplayIndex = 0\n\n  @ContentChildren('floVideoAutoplay', { descendants: true }) public readonly videos: QueryList<ElementRef<HTMLVideoElement>>\n\n  private readonly onDestroySource = new Subject()\n  private readonly onDestroy = this.onDestroySource.pipe(share())\n  private readonly canExecute = () => this.floVideoAutoplay === true || this.floVideoAutoplay === ''\n  private readonly maybeVideoElement = () => maybe(this.elmRef.nativeElement).filter(e => e.nodeName === 'VIDEO')\n  private readonly maybeUnmuteActionRef = () => maybe(this.floVideoAutoplayClickUnmuteRef).filter(a => a as any !== '')\n  private readonly maybePlayActionRef = () => maybe(this.floVideoAutoplayClickPlayRef).filter(a => a as any !== '')\n\n  private readonly hideRef = (ref: HTMLElement) => this.rd.setStyle(ref, 'display', 'none')\n  private readonly showRef = (ref: HTMLElement) => this.rd.setStyle(ref, 'display', 'block')\n\n  private readonly volumeChange = (videoElement: HTMLVideoElement) =>\n    fromEvent(videoElement, 'volumechange', { passive: true }).pipe(\n      map(evt => evt.target as HTMLVideoElement),\n      share(),\n      takeUntil(this.onDestroy))\n\n  private readonly initOnVideo = (videoElement: HTMLVideoElement) =>\n    fromEvent(videoElement, 'loadstart').pipe(\n      tap(() => videoElement.setAttribute('autoplay', 'true')),\n      map(evt => evt.target as HTMLVideoElement),\n      tryPlayVideoAsIs,\n      tryPlayVideoMuted,\n      take(1)\n    ).subscribe(res => { // could not autoplay, must click to play\n      res.videoElement.preload = 'none'\n      res.videoElement.muted = false\n      res.videoElement.volume = 1\n      this.maybePlayActionRef().tapSome(this.showRef)\n    })\n\n  constructor(private elmRef: ElementRef<HTMLVideoElement>, private rd: Renderer2) { }\n\n  private readonly runUnmuteSequence = (actionRef: HTMLElement) => (runOnce: boolean) => (videoElement: HTMLVideoElement) => {\n    videoElement.setAttribute('autoplay', 'true')\n    fromEvent(actionRef, 'click').pipe(takeUntil(this.onDestroy)).subscribe(() => {\n      videoElement.muted = false\n      videoElement.volume = 1\n    })\n\n    this.volumeChange(videoElement).pipe(filter(v => !v.muted || v.volume > 0), takeUntil(this.onDestroy))\n      .subscribe(() => this.hideRef(actionRef))\n    const showRef = this.volumeChange(videoElement).pipe(filter(v => v.muted || v.volume <= 0));\n    (runOnce ? showRef.pipe(take(1)) : showRef).subscribe(() => this.showRef(actionRef))\n  }\n\n  ngAfterContentInit() {\n    if (!this.canExecute()) { return }\n\n    this.maybeVideoElement().tapSome(this.initOnVideo)\n    this.videos.map(a => a.nativeElement).forEach(this.initOnVideo)\n\n    this.maybeUnmuteActionRef().tapSome(ref => {\n      this.hideRef(ref)\n\n      either(this.maybeVideoElement().valueOrUndefined(),\n        maybe(this.videos.toArray()[this.floVideoAutoplayIndex]).map(a => a.nativeElement).valueOrUndefined())\n        .tap({\n          left: this.runUnmuteSequence(ref)(false),\n          right: this.runUnmuteSequence(ref)(true)\n        })\n    })\n\n    this.maybePlayActionRef().tapSome(actionRef => {\n      this.hideRef(actionRef)\n\n      fromEvent(actionRef, 'click').pipe(takeUntil(this.onDestroy)).subscribe(() => {\n        this.hideRef(actionRef)\n        this.maybeVideoElement().tapSome(v => v.play())\n      })\n    })\n  }\n\n  ngOnDestroy() {\n    this.onDestroySource.next()\n    this.onDestroySource.complete()\n  }\n}\n","import { NgModule } from '@angular/core'\nimport { FloVideoAutoplayDirective } from './ng-video-autoplay.directive'\n\n@NgModule({\n  declarations: [\n    FloVideoAutoplayDirective\n  ],\n  exports: [\n    FloVideoAutoplayDirective\n  ]\n})\nexport class FloVideoAutoplayModule { }\n"],"names":[],"mappings":"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"}