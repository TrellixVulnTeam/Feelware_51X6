{"version":3,"file":"flosportsinc-ng-video-autoplay.umd.js","sources":["ng://@flosportsinc/ng-video-autoplay/lib/ng-video-autoplay.directive.ts","ng://@flosportsinc/ng-video-autoplay/lib/ng-video-autoplay.module.ts"],"sourcesContent":["import { Directive, ElementRef, Input, Renderer2, OnDestroy, AfterContentInit, ContentChildren, QueryList } from '@angular/core'\nimport { share, takeUntil, map, flatMap, filter, tap, take } from 'rxjs/operators'\nimport { fromEvent, Subject, Observable } from 'rxjs'\nimport { maybe, either } from 'typescript-monads'\n\ninterface VideoHaltStatus {\n  readonly videoElement: HTMLVideoElement\n  readonly halted: boolean\n}\n\n// tslint:disable:no-object-mutation\nconst filterHalted =\n  (source: Observable<VideoHaltStatus>) =>\n    source.pipe(filter(res => res.halted === true))\n\nconst tryPlayVideoAsIs =\n  (source: Observable<HTMLVideoElement>) =>\n    source.pipe(flatMap(videoElement => videoElement.play()\n      .then(() => ({ videoElement, halted: false }))\n      .catch(() => ({ videoElement, halted: true }))\n    ), filterHalted)\n\nconst tryPlayVideoMuted =\n  (source: Observable<VideoHaltStatus>) =>\n    source.pipe(map(res => {\n      res.videoElement.muted = true\n      res.videoElement.volume = 0\n      return res.videoElement\n    }), tryPlayVideoAsIs)\n\n// 1) attempt to play as-is (including autoplay + unmuted)\n// 2) attempt to play muted, showing unmite button\n// 3) show click to play\n@Directive({\n  selector: '[floVideoAutoplay]'\n})\nexport class FloVideoAutoplayDirective implements AfterContentInit, OnDestroy {\n  @Input() public readonly floVideoAutoplay = true\n  @Input() public readonly floVideoAutoplayClickUnmuteRef?: HTMLElement\n  @Input() public readonly floVideoAutoplayClickPlayRef?: HTMLElement\n  @Input() public readonly floVideoAutoplayIndex = 0\n\n  @ContentChildren('floVideoAutoplay', { descendants: true }) public readonly videos: QueryList<ElementRef<HTMLVideoElement>>\n\n  private readonly onDestroySource = new Subject()\n  private readonly onDestroy = this.onDestroySource.pipe(share())\n  private readonly canExecute = () => this.floVideoAutoplay === true || this.floVideoAutoplay === ''\n  private readonly maybeVideoElement = () => maybe(this.elmRef.nativeElement).filter(e => e.nodeName === 'VIDEO')\n  private readonly maybeUnmuteActionRef = () => maybe(this.floVideoAutoplayClickUnmuteRef).filter(a => a as any !== '')\n  private readonly maybePlayActionRef = () => maybe(this.floVideoAutoplayClickPlayRef).filter(a => a as any !== '')\n\n  private readonly hideRef = (ref: HTMLElement) => this.rd.setStyle(ref, 'display', 'none')\n  private readonly showRef = (ref: HTMLElement) => this.rd.setStyle(ref, 'display', 'block')\n\n  private readonly volumeChange = (videoElement: HTMLVideoElement) =>\n    fromEvent(videoElement, 'volumechange', { passive: true }).pipe(\n      map(evt => evt.target as HTMLVideoElement),\n      share(),\n      takeUntil(this.onDestroy))\n\n  private readonly initOnVideo = (videoElement: HTMLVideoElement) =>\n    fromEvent(videoElement, 'loadstart').pipe(\n      tap(() => videoElement.setAttribute('autoplay', 'true')),\n      map(evt => evt.target as HTMLVideoElement),\n      tryPlayVideoAsIs,\n      tryPlayVideoMuted,\n      take(1)\n    ).subscribe(res => { // could not autoplay, must click to play\n      res.videoElement.preload = 'none'\n      res.videoElement.muted = false\n      res.videoElement.volume = 1\n      this.maybePlayActionRef().tapSome(this.showRef)\n    })\n\n  constructor(private elmRef: ElementRef<HTMLVideoElement>, private rd: Renderer2) { }\n\n  private readonly runUnmuteSequence = (actionRef: HTMLElement) => (runOnce: boolean) => (videoElement: HTMLVideoElement) => {\n    videoElement.setAttribute('autoplay', 'true')\n    fromEvent(actionRef, 'click').pipe(takeUntil(this.onDestroy)).subscribe(() => {\n      videoElement.muted = false\n      videoElement.volume = 1\n    })\n\n    this.volumeChange(videoElement).pipe(filter(v => !v.muted || v.volume > 0), takeUntil(this.onDestroy))\n      .subscribe(() => this.hideRef(actionRef))\n    const showRef = this.volumeChange(videoElement).pipe(filter(v => v.muted || v.volume <= 0));\n    (runOnce ? showRef.pipe(take(1)) : showRef).subscribe(() => this.showRef(actionRef))\n  }\n\n  ngAfterContentInit() {\n    if (!this.canExecute()) { return }\n\n    this.maybeVideoElement().tapSome(this.initOnVideo)\n    this.videos.map(a => a.nativeElement).forEach(this.initOnVideo)\n\n    this.maybeUnmuteActionRef().tapSome(ref => {\n      this.hideRef(ref)\n\n      either(this.maybeVideoElement().valueOrUndefined(),\n        maybe(this.videos.toArray()[this.floVideoAutoplayIndex]).map(a => a.nativeElement).valueOrUndefined())\n        .tap({\n          left: this.runUnmuteSequence(ref)(false),\n          right: this.runUnmuteSequence(ref)(true)\n        })\n    })\n\n    this.maybePlayActionRef().tapSome(actionRef => {\n      this.hideRef(actionRef)\n\n      fromEvent(actionRef, 'click').pipe(takeUntil(this.onDestroy)).subscribe(() => {\n        this.hideRef(actionRef)\n        this.maybeVideoElement().tapSome(v => v.play())\n      })\n    })\n  }\n\n  ngOnDestroy() {\n    this.onDestroySource.next()\n    this.onDestroySource.complete()\n  }\n}\n","import { NgModule } from '@angular/core'\nimport { FloVideoAutoplayDirective } from './ng-video-autoplay.directive'\n\n@NgModule({\n  declarations: [\n    FloVideoAutoplayDirective\n  ],\n  exports: [\n    FloVideoAutoplayDirective\n  ]\n})\nexport class FloVideoAutoplayModule { }\n"],"names":["filter","flatMap","map","Subject","share","maybe","fromEvent","takeUntil","tap","take","either","Directive","ElementRef","Renderer2","Input","ContentChildren","NgModule"],"mappings":"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"}