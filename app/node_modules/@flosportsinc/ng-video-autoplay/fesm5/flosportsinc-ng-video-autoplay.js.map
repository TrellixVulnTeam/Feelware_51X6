{"version":3,"file":"flosportsinc-ng-video-autoplay.js","sources":["ng://@flosportsinc/ng-video-autoplay/lib/ng-video-autoplay.directive.ts","ng://@flosportsinc/ng-video-autoplay/lib/ng-video-autoplay.module.ts"],"sourcesContent":["import { Directive, ElementRef, Input, Renderer2, OnDestroy, AfterContentInit, ContentChildren, QueryList } from '@angular/core'\nimport { share, takeUntil, map, flatMap, filter, tap, take } from 'rxjs/operators'\nimport { fromEvent, Subject, Observable } from 'rxjs'\nimport { maybe, either } from 'typescript-monads'\n\ninterface VideoHaltStatus {\n  readonly videoElement: HTMLVideoElement\n  readonly halted: boolean\n}\n\n// tslint:disable:no-object-mutation\nconst filterHalted =\n  (source: Observable<VideoHaltStatus>) =>\n    source.pipe(filter(res => res.halted === true))\n\nconst tryPlayVideoAsIs =\n  (source: Observable<HTMLVideoElement>) =>\n    source.pipe(flatMap(videoElement => videoElement.play()\n      .then(() => ({ videoElement, halted: false }))\n      .catch(() => ({ videoElement, halted: true }))\n    ), filterHalted)\n\nconst tryPlayVideoMuted =\n  (source: Observable<VideoHaltStatus>) =>\n    source.pipe(map(res => {\n      res.videoElement.muted = true\n      res.videoElement.volume = 0\n      return res.videoElement\n    }), tryPlayVideoAsIs)\n\n// 1) attempt to play as-is (including autoplay + unmuted)\n// 2) attempt to play muted, showing unmite button\n// 3) show click to play\n@Directive({\n  selector: '[floVideoAutoplay]'\n})\nexport class FloVideoAutoplayDirective implements AfterContentInit, OnDestroy {\n  @Input() public readonly floVideoAutoplay = true\n  @Input() public readonly floVideoAutoplayClickUnmuteRef?: HTMLElement\n  @Input() public readonly floVideoAutoplayClickPlayRef?: HTMLElement\n  @Input() public readonly floVideoAutoplayIndex = 0\n\n  @ContentChildren('floVideoAutoplay', { descendants: true }) public readonly videos: QueryList<ElementRef<HTMLVideoElement>>\n\n  private readonly onDestroySource = new Subject()\n  private readonly onDestroy = this.onDestroySource.pipe(share())\n  private readonly canExecute = () => this.floVideoAutoplay === true || this.floVideoAutoplay === ''\n  private readonly maybeVideoElement = () => maybe(this.elmRef.nativeElement).filter(e => e.nodeName === 'VIDEO')\n  private readonly maybeUnmuteActionRef = () => maybe(this.floVideoAutoplayClickUnmuteRef).filter(a => a as any !== '')\n  private readonly maybePlayActionRef = () => maybe(this.floVideoAutoplayClickPlayRef).filter(a => a as any !== '')\n\n  private readonly hideRef = (ref: HTMLElement) => this.rd.setStyle(ref, 'display', 'none')\n  private readonly showRef = (ref: HTMLElement) => this.rd.setStyle(ref, 'display', 'block')\n\n  private readonly volumeChange = (videoElement: HTMLVideoElement) =>\n    fromEvent(videoElement, 'volumechange', { passive: true }).pipe(\n      map(evt => evt.target as HTMLVideoElement),\n      share(),\n      takeUntil(this.onDestroy))\n\n  private readonly initOnVideo = (videoElement: HTMLVideoElement) =>\n    fromEvent(videoElement, 'loadstart').pipe(\n      tap(() => videoElement.setAttribute('autoplay', 'true')),\n      map(evt => evt.target as HTMLVideoElement),\n      tryPlayVideoAsIs,\n      tryPlayVideoMuted,\n      take(1)\n    ).subscribe(res => { // could not autoplay, must click to play\n      res.videoElement.preload = 'none'\n      res.videoElement.muted = false\n      res.videoElement.volume = 1\n      this.maybePlayActionRef().tapSome(this.showRef)\n    })\n\n  constructor(private elmRef: ElementRef<HTMLVideoElement>, private rd: Renderer2) { }\n\n  private readonly runUnmuteSequence = (actionRef: HTMLElement) => (runOnce: boolean) => (videoElement: HTMLVideoElement) => {\n    videoElement.setAttribute('autoplay', 'true')\n    fromEvent(actionRef, 'click').pipe(takeUntil(this.onDestroy)).subscribe(() => {\n      videoElement.muted = false\n      videoElement.volume = 1\n    })\n\n    this.volumeChange(videoElement).pipe(filter(v => !v.muted || v.volume > 0), takeUntil(this.onDestroy))\n      .subscribe(() => this.hideRef(actionRef))\n    const showRef = this.volumeChange(videoElement).pipe(filter(v => v.muted || v.volume <= 0));\n    (runOnce ? showRef.pipe(take(1)) : showRef).subscribe(() => this.showRef(actionRef))\n  }\n\n  ngAfterContentInit() {\n    if (!this.canExecute()) { return }\n\n    this.maybeVideoElement().tapSome(this.initOnVideo)\n    this.videos.map(a => a.nativeElement).forEach(this.initOnVideo)\n\n    this.maybeUnmuteActionRef().tapSome(ref => {\n      this.hideRef(ref)\n\n      either(this.maybeVideoElement().valueOrUndefined(),\n        maybe(this.videos.toArray()[this.floVideoAutoplayIndex]).map(a => a.nativeElement).valueOrUndefined())\n        .tap({\n          left: this.runUnmuteSequence(ref)(false),\n          right: this.runUnmuteSequence(ref)(true)\n        })\n    })\n\n    this.maybePlayActionRef().tapSome(actionRef => {\n      this.hideRef(actionRef)\n\n      fromEvent(actionRef, 'click').pipe(takeUntil(this.onDestroy)).subscribe(() => {\n        this.hideRef(actionRef)\n        this.maybeVideoElement().tapSome(v => v.play())\n      })\n    })\n  }\n\n  ngOnDestroy() {\n    this.onDestroySource.next()\n    this.onDestroySource.complete()\n  }\n}\n","import { NgModule } from '@angular/core'\nimport { FloVideoAutoplayDirective } from './ng-video-autoplay.directive'\n\n@NgModule({\n  declarations: [\n    FloVideoAutoplayDirective\n  ],\n  exports: [\n    FloVideoAutoplayDirective\n  ]\n})\nexport class FloVideoAutoplayModule { }\n"],"names":[],"mappings":"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"}